function DateTimePicker(div,options){var me=this;me.div=$(div[0]),me.datecomponentchanged=new CustomEvent("datecomponentchanged"),me.cfg=$.extend({format:"Y-m-d H:i:s",placeholder:"_",className:"",value:null},options);function trimPlaceholders(string){for(var str=(string+"").split(""),i=0;str[i]===me.cfg.placeholder;)str[i++]="";for(i=str.length-1;str[i]===me.cfg.placeholder;)str[i--]="";return str.join("")}function setInputCaretPos(){if(0===innerCaretPos)me.input[0].setSelectionRange(0,0);else{var k=0,i=0;for(i in mask)if(mask[i]===me.cfg.placeholder&&k++,k===innerCaretPos)break;me.input[0].setSelectionRange(+i+1,+i+1)}}function initInputString(mask){if(objValue){var str=me.cfg.format.split("");res="";for(var i in str)if(/[dmYHis]/.test(str[i]))switch(str[i]){case"d":res+=("0"+objValue.getDate()).slice(-2);break;case"m":res+=("0"+objValue.getMonth()).slice(-2);break;case"Y":res+=objValue.getFullYear();break;case"H":res+=("0"+objValue.getHours()).slice(-2);break;case"i":res+=("0"+objValue.getMinutes()).slice(-2);break;case"s":res+=("0"+objValue.getSeconds()).slice(-2)}}else{var res="";mask=mask.split("");for(var i in mask)mask[i]===me.cfg.placeholder&&(res+=mask[i])}return res}function getInnerCaretPos(pos){for(var txt=me.input.val().split(""),iPos=0;pos--;)("0"<=txt[pos]&&txt[pos]<="9"||txt[pos]===me.cfg.placeholder)&&iPos++;return iPos}function applyOnMask(){for(var res=makeMask().split(""),str=inputString.split(""),i=0,j=0;i<str.length&&j<res.length;)res[j]===me.cfg.placeholder?res[j++]=str[i++]:j++;return res.join("")}function updateDateObject(){objValue=new Date(+dateComponents.Y,dateComponents.m-1,+dateComponents.d,+dateComponents.H,+dateComponents.i,+dateComponents.s)}function formatter(format){return null===objValue?"":format.replace("d",("0"+objValue.getDate()).slice(-2)).replace("m",("0"+(objValue.getMonth()+1)).slice(-2)).replace("Y",objValue.getFullYear()).replace("H",("0"+objValue.getHours()).slice(-2)).replace("i",("0"+objValue.getMinutes()).slice(-2)).replace("s",("0"+objValue.getSeconds()).slice(-2))}function updateComponents(inputCaretPos){var lastComponent=currentComponent;currentComponent=function(pos){var char=componentString[pos];return/[dmYHis]/.test(char)&&void 0!==char||(char=componentString[pos-1]),/[dmYHis]/.test(char)?char:"undefined"}(inputCaretPos),Object.keys(dateComponents).forEach(function(k){dateComponents[k]=function(component){var cs=componentString.split(""),condensed=[];for(var i in cs.forEach(function(c){/[dmYHis]/.test(c)&&condensed.push(c)}),condensed=condensed.join(""),res="",inputString)condensed[i]===component&&(res+=inputString[i]);return res}(k)}),lastComponent!==currentComponent&&me.input.trigger("datecomponentchanged",lastComponent)}function validateComponentValue(component){if(""===dateComponents[component])return!1;var value=+dateComponents[component];if(isNaN(value))return!1;switch(component){case"d":if(value<1||31<value)return!1;break;case"m":if(value<1||12<value)return!1;break;case"Y":if(value<0||9999<value)return!1;break;case"H":if(value<0||24<value)return!1;break;case"i":case"s":if(value<0||59<value)return!1}return!0}function syncFromDateComponents(){var str=me.cfg.format.split(""),res="";for(var i in str)/[dmYHis]/.test(str[i])&&(res+=dateComponents[str[i]]);inputString=res,me.input.val(applyOnMask()),setInputCaretPos()}function clearValue(){dateComponents={d:0,m:0,Y:0,H:0,i:0,s:0},inputString=initInputString(mask),objValue=null}var makeMask=function(){return me.cfg.format.replace("d",me.cfg.placeholder.repeat(2)).replace("m",me.cfg.placeholder.repeat(2)).replace("Y",me.cfg.placeholder.repeat(4)).replace("H",me.cfg.placeholder.repeat(2)).replace("i",me.cfg.placeholder.repeat(2)).replace("s",me.cfg.placeholder.repeat(2))},objValue=me.cfg.value,mask=makeMask(),inputString=initInputString(mask),componentString=me.cfg.format.replace("d","dd").replace("m","mm").replace("Y","YYYY").replace("H","HH").replace("i","ii").replace("s","ss"),inputStringLength=inputString.length,innerCaretPos=0,currentComponent=me.cfg.format[me.cfg.format.search(/[dmYHis]/)],dateComponentsDefaults={d:1,m:1,Y:(new Date).getFullYear(),H:0,i:0,s:0},dateComponents={d:0,m:0,Y:0,H:0,i:0,s:0};me.input=$('<input type="text" >').appendTo(me.div).addClass(me.cfg.className).val(applyOnMask()),updateComponents(0),me.getValue=function(type){switch(type=type||"text"){case"text":return formatter(me.cfg.format);case"date":return objValue;default:return formatter(me.cfg.format)}},me.input.on("keydown",function(e){var k=e.keyCode;116===!k&&e.preventDefault();var inputCaretPos=this.selectionStart,selectionEnd=getInnerCaretPos(this.selectionEnd);if(36===k)innerCaretPos=0,setInputCaretPos(),updateComponents(this.selectionStart);else if(35===k)innerCaretPos=inputStringLength,setInputCaretPos(),updateComponents(this.selectionStart);else if(37===k||39===k||38===k||40===k){switch(k){case 37:innerCaretPos&&inputCaretPos--;break;case 39:innerCaretPos<inputStringLength&&inputCaretPos++}updateComponents(inputCaretPos),innerCaretPos=getInnerCaretPos(inputCaretPos)}else if(48<=k&&k<=57||96<=k&&k<=105||46===k||8===k){var str=inputString.split("");if(48<=k&&k<=57||96<=k&&k<=105){if(innerCaretPos<inputStringLength){str[innerCaretPos++]=e.key;for(var i=innerCaretPos;i<selectionEnd&&i<inputStringLength;i++)str[i]=me.cfg.placeholder;inputString=str.join(""),updateComponents(inputCaretPos+1)}}else if(46===k){if(innerCaretPos<inputStringLength){if(innerCaretPos!==selectionEnd)for(;innerCaretPos<selectionEnd;innerCaretPos++)str[innerCaretPos]=me.cfg.placeholder;else str[innerCaretPos++]=me.cfg.placeholder;inputString=str.join(""),updateComponents(inputCaretPos+1)}}else if(8===k){if(innerCaretPos!==selectionEnd){for(i=innerCaretPos;innerCaretPos<selectionEnd;innerCaretPos++)str[innerCaretPos]=me.cfg.placeholder;innerCaretPos=i}else innerCaretPos&&(str[--innerCaretPos]=me.cfg.placeholder);inputString=str.join("");var newPos=1<inputCaretPos?inputCaretPos-2:inputCaretPos-1;newPos<0&&(newPos=0),updateComponents(newPos)}}inputString=inputString.substring(0,inputStringLength),trimPlaceholders(inputString).length||clearValue()}),me.input.on("click",function(){var inputCaretPos=this.selectionStart;innerCaretPos=getInnerCaretPos(inputCaretPos),updateComponents(inputCaretPos)}),me.input.on("input",function(){me.input.val(applyOnMask()),setInputCaretPos()}),me.input.on("paste",function(){var pastedData=(event.clipboardData||event.originalEvent.clipboardData||window.clipboardData).getData("text").split(""),selectionStart=getInnerCaretPos(this.selectionStart),selectionEnd=getInnerCaretPos(this.selectionEnd);for(i in str=inputString.split(""),pastedData)/[0-9]/.test(pastedData[i])&&selectionStart<selectionEnd&&(str[selectionStart++]=pastedData[i]);inputString=str.join(""),innerCaretPos=selectionStart}),me.input.on("select",function(){innerCaretPos=getInnerCaretPos(this.selectionStart)}),me.input.on("datecomponentchanged",function(e,comp){var comp_value=dateComponents[comp]+"";trimPlaceholders(comp_value).length&&comp_value.includes(me.cfg.placeholder)&&(dateComponents[comp]=("000"+trimPlaceholders(comp_value)).slice("Y"===comp?-4:-2)),updateDateObject(),syncFromDateComponents()}),me.input.on("blur",function(){if(trimPlaceholders(inputString).length){$(this).trigger("datecomponentchanged",currentComponent);var comps=Object.keys(dateComponents);for(var c in comps)validateComponentValue(comps[c])||(component=comps[c],dateComponents[component]=("000"+dateComponentsDefaults[component]).slice("Y"===component?-4:-2));syncFromDateComponents(),updateDateObject()}else clearValue();var component})}